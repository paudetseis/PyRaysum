<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example 3: Invert a Receiver Function &mdash; pyraysum 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Example 2: Reproducing Receiver Functions for Dipping and Anisotropic Subsurface Structure" href="../2/2_reproduce_Porter-2011.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> pyraysum
            <img src="../../_static/PyRaysum_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quick Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../links.html">GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../links.html#references">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../init.html">Licence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../init.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../init.html#usage">Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#modules">Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1/1_make_seismograms.html">Example 1: Compare PyRaysum with other synthetic and real data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2/2_reproduce_Porter-2011.html">Example 2: Reproducing Receiver Functions for Dipping and Anisotropic Subsurface Structure</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example 3: Invert a Receiver Function</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#definition-of-the-forward-computation">Definition of the Forward Computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#definition-of-the-misfit-function">Definition of the Misfit Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#plotting-function-for-data-vs-model-prediction">Plotting Function for Data vs. Model Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inversion-workflow">Inversion Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#recording-geometry">Recording Geometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loading-a-receiver-function">Loading a Receiver Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-of-starting-model-and-run-control-parameters">Setup of Starting Model and Run Control Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#definition-of-a-custom-phaselist">Definition of a Custom Phaselist</a></li>
<li class="toctree-l3"><a class="reference internal" href="#faster-array-based-postprocessing">Faster Array-Based Postprocessing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#a-first-look-at-the-observed-and-predicted-data-vectors">A First Look at the Observed and Predicted Data Vectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inverse-modeling-with-scipys-optimize-module">Inverse Modeling with Scipy’s Optimize Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#results">Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jupyter Notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nbviewer.jupyter.org/github/paudetseis/PyRaysum/blob/main/pyraysum/examples/notebooks/1_make_seismograms.ipynb">Example 1: Compare PyRaysum with other synthetic and real data</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nbviewer.jupyter.org/github/paudetseis/PyRaysum/blob/main/pyraysum/examples/notebooks/2_reproduce_Porter-2011.ipynb">Example 2: Reproducing Figure 2 in Porter et al. (2011)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nbviewer.jupyter.org/github/paudetseis/PyRaysum/blob/main/pyraysum/examples/notebooks/3_invert_rf.ipynb">Example 3: Invert a receiver function</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyraysum</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Example 3: Invert a Receiver Function</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/3/3_invert_rf.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-3-invert-a-receiver-function">
<h1>Example 3: Invert a Receiver Function<a class="headerlink" href="#example-3-invert-a-receiver-function" title="Permalink to this heading"></a></h1>
<p>In this example we are going to load receiver functions that have been
created from seismograms recorded at station Hyderabad, India, from 3
earthquakes that occurred in the Philippines. The source station
configuration is identical to the one in example 1. We are going to use
<code class="docutils literal notranslate"><span class="pre">pyraysum</span></code> to generate receiver function, as in example 2. This
example explores the provisions of <code class="docutils literal notranslate"><span class="pre">pyraysum</span></code> for time optimized
execution. We are going to directly invoke the Fortran routine
<code class="docutils literal notranslate"><span class="pre">run_bare()</span></code> from the <code class="docutils literal notranslate"><span class="pre">fraysum</span></code> module with <code class="docutils literal notranslate"><span class="pre">python</span></code> convenience
functions from the <code class="docutils literal notranslate"><span class="pre">prs</span></code> module. The inversion will be carried out by
the <code class="docutils literal notranslate"><span class="pre">dual_annealing()</span></code> function from <code class="docutils literal notranslate"><span class="pre">scipy.optimize</span></code>. The filtering
and spectral division that is required to create receiver functions from
the synthetic seismograms is carried out using <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array methods.
finally, we will plot the results with <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyraysum</span> <span class="kn">import</span> <span class="n">prs</span><span class="p">,</span> <span class="n">frs</span>
<span class="kn">from</span> <span class="nn">fraysum</span> <span class="kn">import</span> <span class="n">run_bare</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">spo</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">mp</span>
</pre></div>
</div>
<section id="definition-of-the-forward-computation">
<h2>Definition of the Forward Computation<a class="headerlink" href="#definition-of-the-forward-computation" title="Permalink to this heading"></a></h2>
<p>We predict waveforms inside a function <code class="docutils literal notranslate"><span class="pre">predictRF()</span></code> that accepts
<code class="docutils literal notranslate"><span class="pre">Model</span></code>, <code class="docutils literal notranslate"><span class="pre">Geometry</span></code>, and <code class="docutils literal notranslate"><span class="pre">RC</span></code> objects, which completely define the
synthetic seismograms to be computed. Only the <code class="docutils literal notranslate"><span class="pre">fthickn</span></code> and <code class="docutils literal notranslate"><span class="pre">fvs</span></code>
attributes of the <code class="docutils literal notranslate"><span class="pre">Model</span></code> will be varied when trying different
parameter combinations. The post-processing is determined by the
bandpass filter corner frequencies <code class="docutils literal notranslate"><span class="pre">freqs</span></code> and the boolean time window
mask <code class="docutils literal notranslate"><span class="pre">ist</span></code> (“is time”). Post processing is performed on the
<code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> variable <code class="docutils literal notranslate"><span class="pre">rfarray</span></code>. Two post-processing functions
are provided. <code class="docutils literal notranslate"><span class="pre">filtered_rf_array</span></code> divides the SV- and SH-spectra by
the P-spectra (i.e., computes a receiver function) and filters the data,
whereas <code class="docutils literal notranslate"><span class="pre">filtered_array</span></code> returns the filtered SV and SH data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predictRF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="c1"># Compute synthetic seismograms</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">run_bare</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fthickn</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">frho</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fvp</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fvs</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fflag</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fani</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ftrend</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fplunge</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fstrike</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fdip</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span>
        <span class="o">*</span><span class="n">geometry</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="o">*</span><span class="n">rc</span><span class="o">.</span><span class="n">parameters</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">rf</span><span class="p">:</span>
        <span class="c1"># Perfrom spectral division and filtering</span>
        <span class="n">frs</span><span class="o">.</span><span class="n">filtered_rf_array</span><span class="p">(</span>
            <span class="n">traces</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">ntr</span><span class="p">,</span> <span class="n">rc</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="n">rc</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Perfrom filtering only</span>
        <span class="n">frs</span><span class="o">.</span><span class="n">filtered_array</span><span class="p">(</span>
            <span class="n">traces</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">ntr</span><span class="p">,</span> <span class="n">rc</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="n">rc</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Window traces and flatten array</span>
    <span class="c1"># This creates alternating radial and transverse RFs for all traces:</span>
    <span class="c1"># R[0] - T[0] - R[1] - T[1] ...</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">rfarray</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ist</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prediction</span>
</pre></div>
</div>
</section>
<section id="definition-of-the-misfit-function">
<h2>Definition of the Misfit Function<a class="headerlink" href="#definition-of-the-misfit-function" title="Permalink to this heading"></a></h2>
<p>Here, we define the misfit function that <code class="docutils literal notranslate"><span class="pre">dual_annealing</span></code> will
minimize. The misfit function requires a model vector <code class="docutils literal notranslate"><span class="pre">theta</span></code> as first
argument. We define the first element of the model vector to be the
crustal thickness and the second one the P-to-S-wave velocity ratio.
<span class="math notranslate nohighlight">\(V_P/V_S\)</span> gets projected to the S-wave velocity assuming a
constant P-wave velocity. After that, we define the misfit <code class="docutils literal notranslate"><span class="pre">cost</span></code>
between the predicted and observed receiver functions (<code class="docutils literal notranslate"><span class="pre">pred</span></code> and
<code class="docutils literal notranslate"><span class="pre">obs</span></code>, respectively) as 1. minus the cross correlation coefficient. A
status message is printed so the user can follow the inversion process.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">misfit</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>

    <span class="c1"># Set parameters to model object</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fthickn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fvp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># predict receiver functions</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">predictRF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">ist</span><span class="p">)</span>

    <span class="c1"># Calculate cross correlation cost function</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;h =</span><span class="si">{: 5.0f}</span><span class="s2">, vpvs =</span><span class="si">{: 5.3f}</span><span class="s2">, cc =</span><span class="si">{: 5.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">cost</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cost</span>
</pre></div>
</div>
</section>
<section id="plotting-function-for-data-vs-model-prediction">
<h2>Plotting Function for Data vs. Model Prediction<a class="headerlink" href="#plotting-function-for-data-vs-model-prediction" title="Permalink to this heading"></a></h2>
<p>This plot function allows us to compare the observed and predicted data
vectors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Observed and modeled data vector&quot;</span><span class="p">)</span>

    <span class="n">imid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;cc = </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dimgray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;modeled&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">imid</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span> <span class="s1">&#39;Radial &#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">imid</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span> <span class="s1">&#39; Transverse&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">imid</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inversion-workflow">
<h2>Inversion Workflow<a class="headerlink" href="#inversion-workflow" title="Permalink to this heading"></a></h2>
<section id="recording-geometry">
<h3>Recording Geometry<a class="headerlink" href="#recording-geometry" title="Permalink to this heading"></a></h3>
<p>Now it is time to run the workflow. We define the back-azimuth and
slowness of seismic rays arriving at Hyderabad from the Philippines. The
time window should span the interval between 0 and 25 seconds after the
arrival of the direct P-wave. Data should be bandpassed filtered between
periods of 20 and 2 seconds.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">baz</span> <span class="o">=</span> <span class="mi">90</span>
    <span class="n">slow</span> <span class="o">=</span> <span class="mf">0.06</span>

    <span class="n">twind</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>  <span class="c1"># seconds time window</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Hz bandpass filter</span>
</pre></div>
</div>
</section>
<section id="loading-a-receiver-function">
<h3>Loading a Receiver Function<a class="headerlink" href="#loading-a-receiver-function" title="Permalink to this heading"></a></h3>
<p>We load the radial and transverse receiver functions from file. The
receiver function has been created from 3 high-quality earthquake
recordings from the Philippines. Note that <code class="docutils literal notranslate"><span class="pre">rfr</span></code> and <code class="docutils literal notranslate"><span class="pre">rft</span></code> here need
to be structured such that the arrival of the direct P-wave is located
in the middle of the array. In other words, the acausal part (earlier
than direct P) must be as long as the causal part (later than direct P).
In this way, the definition of the time window mask <code class="docutils literal notranslate"><span class="pre">ist</span></code> is such that
it can be reused for post-processing of the synthetic receiver
functions. The windowed receiver function are concatenated to yield the
data vector.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load saved stream</span>
<span class="n">time</span><span class="p">,</span> <span class="n">rfr</span><span class="p">,</span> <span class="n">rft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;../data/rf_hyb.dat&quot;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ist</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">twind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">twind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rfr</span><span class="p">[</span><span class="n">ist</span><span class="p">],</span> <span class="n">rft</span><span class="p">[</span><span class="n">ist</span><span class="p">]))</span>
</pre></div>
</div>
</section>
<section id="setup-of-starting-model-and-run-control-parameters">
<h3>Setup of Starting Model and Run Control Parameters<a class="headerlink" href="#setup-of-starting-model-and-run-control-parameters" title="Permalink to this heading"></a></h3>
<p>We set up the starting subsurface velocity model using Saul et
al. (2000), as well as the recording geometry.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">thickn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">rho</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2800</span><span class="p">,</span> <span class="mi">3600</span><span class="p">]</span>
<span class="n">vp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6400</span><span class="p">,</span> <span class="mi">8100</span><span class="p">]</span>
<span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">4600</span><span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">prs</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">thickn</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">)</span>
<span class="n">geometry</span> <span class="o">=</span> <span class="n">prs</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">baz</span><span class="p">,</span> <span class="n">slow</span><span class="p">)</span>
</pre></div>
</div>
<p>We choose the RC parameters so that they match the processing of the
receiver functions. In the present case, the receiver functions are
rotated to the P-SV-SH ray coordinate system (<code class="docutils literal notranslate"><span class="pre">rot=2</span></code>), and the
sampling interval (<code class="docutils literal notranslate"><span class="pre">dt</span></code>) and number of samples (<code class="docutils literal notranslate"><span class="pre">npts</span></code>) are set to
match the input. The <code class="docutils literal notranslate"><span class="pre">align=1</span></code> option (together with <code class="docutils literal notranslate"><span class="pre">shift=None</span></code>,
which is the default) ensures that the direct P wave is located at the
first sample. <code class="docutils literal notranslate"><span class="pre">mults=3</span></code> is required to pre-set the list of phases to
be computed. This is the recommended option for all time-sensitive
applications, as <code class="docutils literal notranslate"><span class="pre">mults=2</span></code> computes many multiples, many of which
might not be used at all.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rc</span> <span class="o">=</span> <span class="n">prs</span><span class="o">.</span><span class="n">Control</span><span class="p">(</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">rot</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">npts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rfr</span><span class="p">),</span>
    <span class="n">align</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mults</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="definition-of-a-custom-phaselist">
<h3>Definition of a Custom Phaselist<a class="headerlink" href="#definition-of-a-custom-phaselist" title="Permalink to this heading"></a></h3>
<p>The phaselist is defined as a list of phase descriptors, which can be
read from a previous forward calculation (e.g. example 1). Each ray
segment is described by a number-letter pair, where the number is the
layer index and the letter the phase descriptor, where uppercase
indicates upgoing rays and lowercase downgoing rays. See the
<code class="docutils literal notranslate"><span class="pre">rc.set_phaselist</span></code> documentation for details.</p>
<p>This phaselist restricts the phases to be computed to:</p>
<ol class="arabic simple" start="0">
<li><p>direct P (<em>P</em>)</p></li>
<li><p>P-to-S converted (<em>PS</em>)</p></li>
<li><p>P reflected at the surface to downgoing S, reflected at Moho to S
(<em>PpP</em>)</p></li>
<li><p>P reflected at the surface to downgoing P, reflected at Moho to S
(<em>PpS</em>)</p></li>
<li><p>P reflected at the surface to downgoing S, reflected at Moho to P
(<em>PsP</em>)</p></li>
</ol>
<p>You can try the effect of incorporating <em>PsS</em> by adding <code class="docutils literal notranslate"><span class="pre">&quot;1P0P0s0S&quot;</span></code>
to the phaselist. The <code class="docutils literal notranslate"><span class="pre">equivalent=True</span></code> keyword implicitly adds such
<em>equivalent</em> phases.</p>
<blockquote>
<div><p>Note: <em>PpS</em> and <em>PsP</em> phases arrive at the same time, but only phases
that end in <em>S</em> are directly visible on the receiver function. Phases
ending in <em>P</em> end up on the <em>P</em> polarized trace of the synthetic
seismogram, where they become part of the denominator of spectral
division when computing the receiver function.)</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rc</span><span class="o">.</span><span class="n">set_phaselist</span><span class="p">([</span><span class="s2">&quot;1P0P&quot;</span><span class="p">,</span> <span class="s2">&quot;1P0S&quot;</span><span class="p">,</span> <span class="s2">&quot;1P0P0p0P&quot;</span><span class="p">,</span> <span class="s2">&quot;1P0P0p0S&quot;</span><span class="p">,</span> <span class="s2">&quot;1P0P0s0P&quot;</span><span class="p">],</span> <span class="n">equivalent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="faster-array-based-postprocessing">
<h3>Faster Array-Based Postprocessing<a class="headerlink" href="#faster-array-based-postprocessing" title="Permalink to this heading"></a></h3>
<p>Swift post processing of the synthetic receiver function is done on the
<code class="docutils literal notranslate"><span class="pre">rfarray</span></code> using numpy array methods, which is initialized here. It has
shape <code class="docutils literal notranslate"><span class="pre">(geometry.ntr,</span> <span class="pre">2,</span> <span class="pre">rc.npts)</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfarray</span> <span class="o">=</span> <span class="n">frs</span><span class="o">.</span><span class="n">make_array</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="a-first-look-at-the-observed-and-predicted-data-vectors">
<h2>A First Look at the Observed and Predicted Data Vectors<a class="headerlink" href="#a-first-look-at-the-observed-and-predicted-data-vectors" title="Permalink to this heading"></a></h2>
<p>Let’s see how well the starting model predicts the data. See what
changes if you set <code class="docutils literal notranslate"><span class="pre">rf=False</span></code>, in which case no spectral division is
performed and the model prediction is the synthetic seismogram. This
expedites the computation, but is less exact.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">predicted</span> <span class="o">=</span> <span class="n">predictRF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">predicted</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/output_21_01.png" src="../../_images/output_21_01.png" />
<p>The first half of the data vector is the radial component and the second
half is the transverse component of the receiver function. In this
example, without dip or anisotropy, energy only gets converted to the
radial, not the transverse component. The first positive wiggle is <em>PS</em>,
the second one <em>PpS</em>. Note the slight mis-alignment between observation
(gray) and prediction (red). The smaller wiggles that arrive later
result from the deconvolution of <em>PpP</em>.</p>
</section>
<section id="inverse-modeling-with-scipys-optimize-module">
<h2>Inverse Modeling with Scipy’s Optimize Module<a class="headerlink" href="#inverse-modeling-with-scipys-optimize-module" title="Permalink to this heading"></a></h2>
<p>We now define the search bounds for dual annealing. This definition
prescribes that the first element of the model vector is the <em>thickness
of layer 0</em> and is searched in an interval of
<span class="math notranslate nohighlight">\(\pm 5000\)</span> m, and its second element is the <span class="math notranslate nohighlight">\(V_P/V_S\)</span>
ratio of layer 0*, searched in an interval of <span class="math notranslate nohighlight">\(\pm\)</span> 0.1.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;thickn&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;thickn&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">),</span>
    <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;vpvs&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;vpvs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Now we are ready to perform the inversion using <code class="docutils literal notranslate"><span class="pre">scipy</span></code>’s <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.dual_annealing.html">dual
annealing</a>
function. It seeks a minimum in the <code class="docutils literal notranslate"><span class="pre">misfit</span></code> function defined above.
The call is in principle interchangeable with other <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/optimize.html#global-optimization">global search
methods from the optimization
module</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">spo</span><span class="o">.</span><span class="n">dual_annealing</span><span class="p">(</span>
    <span class="n">misfit</span><span class="p">,</span>
    <span class="n">bounds</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">ist</span><span class="p">,</span> <span class="n">observed</span><span class="p">),</span>
    <span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">h</span> <span class="o">=</span> <span class="mi">28745</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.868</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.408</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27107</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.690</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.028</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">32605</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.826</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.542</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31991</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.826</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.645</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31991</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.805</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.697</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31991</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.805</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.697</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31991</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.805</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.697</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31991</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.805</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.697</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27506</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.877</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.611</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29815</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.865</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.622</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">30922</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.865</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.673</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">30922</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.818</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.695</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">28651</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.841</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.307</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33587</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.873</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.110</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31375</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.873</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.598</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31375</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.877</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.598</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25540</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.762</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.109</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27033</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.678</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.002</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34752</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.678</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.528</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34752</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.699</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.482</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">28105</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.706</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.023</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27870</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.750</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.346</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34876</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.750</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.351</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34876</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.809</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.144</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33399</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.817</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.400</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">32429</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.826</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.563</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33830</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.826</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.246</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33830</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.720</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.603</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25188</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.778</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.134</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29661</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.691</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.034</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33416</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.691</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.654</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33416</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.744</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.611</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33839</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.825</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.246</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33327</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.694</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.660</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25421</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.694</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.024</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25421</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.874</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.542</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31451</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.679</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.352</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31523</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.763</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.682</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34688</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.763</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.339</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34688</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.685</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.528</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">32610</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.855</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.406</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">33846</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.751</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.520</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34880</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.751</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.351</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34880</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.738</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.377</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29890</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.861</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.627</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29687</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.760</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.282</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">26578</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.760</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.208</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">26578</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.730</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.102</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">28745</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.707</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.007</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31883</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.754</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.699</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25874</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.754</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.137</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25874</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.772</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.167</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31883</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.754</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.699</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31883</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.754</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.699</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31883</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.754</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.699</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">30617</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.829</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.683</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34402</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.849</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.072</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31076</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.849</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.686</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31076</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.765</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.612</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25822</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.847</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.442</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34603</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.721</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.466</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29529</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.721</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.102</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34603</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.740</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.421</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">26306</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.680</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.011</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27198</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.705</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.090</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">30551</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.705</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.250</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">30551</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.829</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.669</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31185</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.686</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.301</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27166</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.848</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.560</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29608</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.848</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.540</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29608</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.766</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.279</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34714</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.746</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.394</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27866</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.763</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.385</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27651</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.763</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.344</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">27651</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.743</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.259</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">31781</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.873</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.530</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">28840</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.683</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.021</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">32547</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.683</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.591</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">32547</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.786</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.659</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">30755</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.809</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.670</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">29781</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.726</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.157</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25482</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.726</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.030</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">25482</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.694</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.048</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34650</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.697</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.518</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">28644</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.747</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.066</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34869</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.747</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.351</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">34869</span><span class="p">,</span> <span class="n">vpvs</span> <span class="o">=</span> <span class="mf">1.868</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=-</span><span class="mf">0.030</span>
</pre></div>
</div>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this heading"></a></h2>
<p>Let’s have a look at the result</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">fun</span><span class="p">:</span> <span class="mf">0.3012503891104201</span>
<span class="n">message</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Maximum number of iteration reached&#39;</span><span class="p">]</span>
   <span class="n">nfev</span><span class="p">:</span> <span class="mi">87</span>
   <span class="n">nhev</span><span class="p">:</span> <span class="mi">0</span>
    <span class="n">nit</span><span class="p">:</span> <span class="mi">20</span>
   <span class="n">njev</span><span class="p">:</span> <span class="mi">2</span>
 <span class="n">status</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">success</span><span class="p">:</span> <span class="kc">True</span>
      <span class="n">x</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mf">3.18828982e+04</span><span class="p">,</span> <span class="mf">1.75376118e+00</span><span class="p">])</span>
</pre></div>
</div>
<p>And assign it to the model</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;thickn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;vpvs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Result found with dual annealing&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Result</span> <span class="n">found</span> <span class="k">with</span> <span class="n">dual</span> <span class="n">annealing</span>
<span class="c1">#  thickn     rho      vp      vs  flag aniso   trend plunge strike   dip</span>
  <span class="mf">31882.9</span>  <span class="mf">2800.0</span>  <span class="mf">6400.0</span>  <span class="mf">3649.3</span>    <span class="mi">1</span>    <span class="mf">0.0</span>     <span class="mf">0.0</span>    <span class="mf">0.0</span>    <span class="mf">0.0</span>   <span class="mf">0.0</span>
      <span class="mf">0.0</span>  <span class="mf">3600.0</span>  <span class="mf">8100.0</span>  <span class="mf">4600.0</span>    <span class="mi">1</span>    <span class="mf">0.0</span>     <span class="mf">0.0</span>    <span class="mf">0.0</span>    <span class="mf">0.0</span>   <span class="mf">0.0</span>
</pre></div>
</div>
<p>The optimal crustal thickness is closer to 32 km, as suggested by Saul
et al. (2000), and the <span class="math notranslate nohighlight">\(V_P/V_S\)</span> ratio closer to 1.8. Note,
however, that we only looked at one receiver function from one
direction. We also did not make any attempt to estimate uncertainties on
the solution.</p>
<p>Finally, we can look at how well the optimized model predicts the data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">predicted</span> <span class="o">=</span> <span class="n">predictRF</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">rfarray</span><span class="p">,</span> <span class="n">ist</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">predicted</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/output_32_0.png" src="../../_images/output_32_0.png" />
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading"></a></h2>
<p>In this example we looked into some basic functions that can be helpful
when using <em>PyRaysum</em> in parameter estimation problems. We defined a
function <code class="docutils literal notranslate"><span class="pre">predictRF</span></code> to predict a receiver function from a given input
model, as well as a <code class="docutils literal notranslate"><span class="pre">misfit</span></code> function whose scalar output should be
minimized through inverse modeling. We then plugged these functions into
<em>SciPy</em>’s <code class="docutils literal notranslate"><span class="pre">optimize</span></code> toolbox to estimate the thickness and <em>S</em>-wave
velocity of the cratonic crust in Hyderabad, India.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Saul, J., Kumar, M. R., &amp; Sarkar, D. (2000). Lithospheric and upper
mantle structure of the Indian Shield, from teleseismic receiver
functions. Geophysical Research Letters, 27(16), 2357-2360.
<a class="reference external" href="https://doi.org/10.1029/1999GL011128">https://doi.org/10.1029/1999GL011128</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../2/2_reproduce_Porter-2011.html" class="btn btn-neutral float-left" title="Example 2: Reproducing Receiver Functions for Dipping and Anisotropic Subsurface Structure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Wasja Bloch, Pascal Audet.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>